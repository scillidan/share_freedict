name: Create Releases

on:
  push:
    tags:
      - "*"
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip p7zip-full

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check latest FreeDict eng-zho source version
        id: check_freedict_version
        run: |
          base_url="https://download.freedict.org/dictionaries/eng-zho/"
          
          echo "Fetching directory listing..."
          html=$(curl -s -L -A "GitHub-Actions-CI" "$base_url")
          
          echo "First 1000 chars of HTML for debug:"
          echo "${html:0:1000}"
          
          # Method 1: Look for version directories (most common for FreeDict)
          versions=$(echo "$html" | grep -oP 'href="(\d{4}\.\d{2}\.\d{2}/)"' | grep -oP '\d{4}\.\d{2}\.\d{2}' | sort -V | tail -1)
          
          if [[ -z "$versions" ]]; then
            echo "Method 1 failed, trying Method 2: direct tar.xz files"
            # Method 2: Look for direct tar.xz files
            versions=$(echo "$html" | grep -oP 'href="[^"]*\.src\.tar\.xz"' | grep -oP 'freedict-eng-zho-(\d{4}\.\d{2}\.\d{2})\.src\.tar\.xz' | grep -oP '\d{4}\.\d{2}\.\d{2}' | sort -V | tail -1)
          fi
          
          if [[ -z "$versions" ]]; then
            echo "Method 2 failed, trying Method 3: broad date pattern"
            # Method 3: Broader pattern for any date-like version in href
            versions=$(echo "$html" | grep -oP 'href="[^"]*(\d{4}\.\d{2}\.\d{2})[^"]*"' | grep -oP '\d{4}\.\d{2}\.\d{2}' | grep -E '^[0-9]{4}\.[0-9]{2}\.[0-9]{2}$' | sort -V | tail -1)
          fi
          
          if [[ -z "$versions" ]]; then
            echo "No FreeDict version found with any method."
            echo "Full HTML sample for debugging:"
            echo "$html" | head -20
            exit 1
          fi
          
          echo "Latest FreeDict version found: $versions"
          
          # Check last_version.txt for this dict
          last_freedict_file="last_freedict_version.txt"
          if [[ -f $last_freedict_file ]]; then
            last_version=$(cat $last_freedict_file)
            if [[ "$versions" == "$last_version" ]]; then
              echo "No new FreeDict version, skipping."
              echo "freedict_version=$versions" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
      
          # Try subdirectory first (common FreeDict pattern)
          tar_url="${base_url}${versions}/freedict-eng-zho-${versions}.src.tar.xz"
          sha_url="${tar_url}.sha512"
          
          echo "Trying subdirectory: $tar_url"
          
          # Download with fallback locations
          if ! curl -LO "$tar_url" 2>/dev/null; then
            echo "Subdirectory failed, trying base directory..."
            tar_url="${base_url}freedict-eng-zho-${versions}.src.tar.xz"
            sha_url="${tar_url}.sha512"
            if ! curl -LO "$tar_url"; then
              echo "Base directory also failed for $tar_url"
              exit 1
            fi
          fi
          
          echo "SHA512 URL: $sha_url"
          curl -LO "$sha_url" || echo "No SHA512 file available"
          
          # List downloaded files
          ls -la *.tar.xz *.sha512 2>/dev/null || true
      
          # Verify SHA512 if available
          sha512_file="freedict-eng-zho-${versions}.src.tar.xz.sha512"
          tar_file="freedict-eng-zho-${versions}.src.tar.xz"
          
          if [[ -f "$tar_file" ]]; then
            echo "Tar file found: $tar_file"
            if [[ -f "$sha512_file" ]]; then
              echo "Verifying SHA512..."
              cat "$sha512_file"
              echo "---"
              
              # Check the format of the sha512 file
              if grep -q "^[0-9a-f]\{128\} " "$sha512_file"; then
                # Standard format: hash filename
                if sha512sum -c "$sha512_file" 2>/dev/null; then
                  echo "SHA512 verification passed (standard format)"
                else
                  echo "SHA512 verification failed (standard format)"
                fi
              elif grep -q "^SHA512" "$sha512_file"; then
                # Alternative format: SHA512(filename)= hash
                expected_hash=$(grep -oP '=\s*\K[0-9a-f]{128}' "$sha512_file" | head -1)
                if [[ -n "$expected_hash" ]]; then
                  actual_hash=$(sha512sum "$tar_file" | cut -d' ' -f1)
                  if [[ "$actual_hash" == "$expected_hash" ]]; then
                    echo "SHA512 verification passed (alternative format)"
                  else
                    echo "SHA512 verification failed!"
                    echo "Expected: $expected_hash"
                    echo "Actual: $actual_hash"
                  fi
                fi
              else
                # Try hash-only format
                hash=$(cat "$sha512_file" | tr -d '[:space:]')
                if [[ ${#hash} -eq 128 ]]; then
                  actual_hash=$(sha512sum "$tar_file" | cut -d' ' -f1)
                  if [[ "$actual_hash" == "$hash" ]]; then
                    echo "SHA512 verification passed (hash only)"
                  fi
                fi
              fi
            else
              echo "No SHA512 file found, skipping verification"
            fi
          else
            echo "Tar file not found: $tar_file"
            exit 1
          fi
      
          echo "$versions" > $last_freedict_file
          echo "FREEDICT_VERSION=$versions" >> $GITHUB_ENV
          echo "freedict_version=$versions" >> $GITHUB_OUTPUT

      - name: Extract FreeDict archive
        if: steps.check_freedict_version.outputs.freedict_version != ''
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          version="${FREEDICT_VERSION}"
          echo "Extracting version: $version"
          7z x "freedict-eng-zho-${version}.src.tar.xz" -o.
          7z x "freedict-eng-zho-${version}.src.tar" -o.
          ls -la

      - name: Move dictd files
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          version="${FREEDICT_VERSION:-${{ steps.extract_version.outputs.version }}}"
          if [[ -d "eng-zho" ]]; then
            mv eng-zho "freedict-eng-zho-${version}"
          fi
          ls -la

      - name: Install pyglossary
        run: |
          pip install pyglossary lxml beautifulsoup4 python-idzip tqdm

      - name: Run pyglossary
        env:
          version: ${{ steps.extract_version.outputs.version }}
        run: |
          version="${FREEDICT_VERSION:-${version}}"
          echo "Processing version: $version"
          
          # Ensure directory exists
          if [[ ! -d "freedict-eng-zho-${version}" ]]; then
            echo "Warning: Source directory not found, using eng-zho"
            [[ -d eng-zho ]] && mv eng-zho "freedict-eng-zho-${version}"
          fi
          
          src_dir="freedict-eng-zho-${version}"
          if [[ ! -f "$src_dir/eng-zho.tei" ]]; then
            echo "Warning: eng-zho.tei not found in $src_dir"
            find . -name "*.tei" | head -1 || exit 1
          fi
          
          # tabfile
          pyglossary "$src_dir/eng-zho.tei" ./_freedict-eng-zho-${version}.txt --read-format=FreeDict --write-format=Tabfile
          
          # tabfile-formatted
          python text_format.py _freedict-eng-zho-${version}.txt _freedict-eng-zho-${version}-formatted.txt || echo "text_format.py failed, continuing..."
          
          # stardict
          pyglossary ./_freedict-eng-zho-${version}-formatted.txt ./freedict-eng-zho-${version}-stardict --read-format=Tabfile --write-format=Stardict --name=ECDICT || \
          pyglossary ./_freedict-eng-zho-${version}.txt ./freedict-eng-zho-${version}-stardict --read-format=Tabfile --write-format=Stardict --name=ECDICT
          
          # tabfile-formatted-html2ansi
          python html2ansi.py _freedict-eng-zho-${version}-formatted.txt freedict-eng-zho-${version}-formatted-html2ansi.txt || \
          cp _freedict-eng-zho-${version}-formatted.txt freedict-eng-zho-${version}-formatted-html2ansi.txt
          
          # sdcv
          pyglossary ./freedict-eng-zho-${version}-formatted-html2ansi.txt ./freedict-eng-zho-${version}-sdcv --read-format=Tabfile --write-format=Stardict --name=ECDICT
          
          # dictd
          pyglossary ./freedict-eng-zho-${version}-formatted-html2ansi.txt ./freedict-eng-zho-${version}-dictd --read-format=Tabfile --write-format=DictOrg --write-options="dictzip=true" --name=ECDICT
          
          # yomichan
          pyglossary ./_freedict-eng-zho-${version}-formatted.txt ./freedict-eng-zho-${version}-yomichan.zip --read-format=Tabfile --write-format=Yomichan --name=ECDICT

      - name: Create zip files
        run: |
          for base in *.ifo; do
            prefix="${base%.ifo}"
            if [[ ! -f "$prefix.ifo" ]]; then
              echo "Skipping $prefix, missing $prefix.ifo"
              continue
            fi
            if [[ ! -f "$prefix.idx" ]]; then
              echo "Skipping $prefix, missing $prefix.idx"
              continue
            fi
            # Check which dict file exists: .dict.dz or .dict
            dict_file=""
            if [[ -f "$prefix.dict.dz" ]]; then
              dict_file="$prefix.dict.dz"
            elif [[ -f "$prefix.dict" ]]; then
              dict_file="$prefix.dict"
            else
              echo "Skipping $prefix, missing dict file"
              continue
            fi
            echo "Creating ${prefix}.zip from $prefix.ifo, $dict_file, $prefix.idx"
            zip -j "${prefix}.zip" "$prefix.ifo" "$dict_file" "$prefix.idx"
          done

      - name: Create zip files for Dictd sets
        env:
          version: ${{ steps.extract_version.outputs.version }}
        run: |
          version="${FREEDICT_VERSION:-${version}}"
          if [[ -f "freedict-eng-zho-${version}-dictd.dict.dz" && -f "freedict-eng-zho-${version}-dictd.index" ]]; then
            zip -j "freedict-eng-zho-${version}-dictd.zip" "freedict-eng-zho-${version}-dictd.dict.dz" "freedict-eng-zho-${version}-dictd.index"
          fi

      - name: Generate SHA256 checksums
        run: |
          for file in ./*.{txt,zip};
          do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256";
              echo "Generated checksum for $file";
            fi
          done

      - name: Extract short name from github.ref
        id: tag_short
        run: echo "short=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          tag_name: ${{ github.ref }}
          name: ${{ steps.tag_short.outputs.short }}
          files: |
            *.sha256
            _*.txt
            freedict-eng-zho-*.zip
