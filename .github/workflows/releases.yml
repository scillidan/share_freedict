name: Create Releases

on:
  push:
    tags:
      - "*"
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check latest FreeDict eng-zho source version
        id: check_freedict_version
        run: |
          base_url="https://download.freedict.org/dictionaries/eng-zho/"
          
          # Try different approaches
          html=$(curl -s -L -A "GitHub-Actions-CI" "$base_url")
          
          # Method 1: Look for the tar.xz files
          versions=$(echo "$html" | grep -oP 'freedict-eng-zho-\d{4}\.\d{2}\.\d{2}\.src\.tar\.xz' | grep -oP '\d{4}\.\d{2}\.\d{2}' | sort -V | uniq | tail -1)
          
          if [[ -z "$versions" ]]; then
            echo "No FreeDict version found in tar.xz files."
            echo "Debug: First 500 chars of HTML:"
            echo "${html:0:500}"
            exit 1
          fi
          
          echo "Latest FreeDict version: $versions"
          
          # Check last_version.txt for this dict
          last_freedict_file="last_freedict_version.txt"
          if [[ -f $last_freedict_file ]]; then
            last_version=$(cat $last_freedict_file)
            if [[ "$versions" == "$last_version" ]]; then
              echo "No new FreeDict version, skipping."
              echo "freedict_version=$versions" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
      
          # Construct the correct URL
          # The files might be in a subdirectory with the version
          tar_url="${base_url}${versions}/freedict-eng-zho-${versions}.src.tar.xz"
          sha_url="${tar_url}.sha512"
          
          echo "Downloading from: $tar_url"
          echo "SHA512 URL: $sha_url"
          
          # Download files
          curl -LO "$tar_url" || { echo "Failed to download $tar_url"; exit 1; }
          curl -LO "$sha_url" || { echo "Failed to download $sha_url"; exit 1; }
          
          # List downloaded files
          ls -la *.tar.xz *.sha512 2>/dev/null || true
      
          # Verify SHA512
          sha512_file="freedict-eng-zho-${versions}.src.tar.xz.sha512"
          tar_file="freedict-eng-zho-${versions}.src.tar.xz"
          
          if [[ ! -f "$sha512_file" ]]; then
            echo "SHA512 file not found: $sha512_file"
            exit 1
          fi
          
          if [[ ! -f "$tar_file" ]]; then
            echo "Tar file not found: $tar_file"
            exit 1
          fi
          
          echo "Verifying SHA512..."
          cat "$sha512_file"
          echo "---"
          
          # Check the format of the sha512 file
          if grep -q "^[0-9a-f]\{128\} " "$sha512_file"; then
            # Standard format: hash filename
            sha512sum -c "$sha512_file"
          elif grep -q "^SHA512" "$sha512_file"; then
            # Alternative format: SHA512(freedict-eng-zho-2024.10.10.src.tar.xz)= hash
            expected_hash=$(grep -oP '=\s*\K[0-9a-f]{128}' "$sha512_file" | head -1)
            if [[ -n "$expected_hash" ]]; then
              actual_hash=$(sha512sum "$tar_file" | cut -d' ' -f1)
              if [[ "$actual_hash" == "$expected_hash" ]]; then
                echo "SHA512 verification passed (alternative format)"
              else
                echo "SHA512 verification failed!"
                echo "Expected: $expected_hash"
                echo "Actual: $actual_hash"
                exit 1
              fi
            else
              echo "Could not parse SHA512 file"
              exit 1
            fi
          else
            # Try to extract the hash (might be just the hash without filename)
            hash=$(cat "$sha512_file" | tr -d '[:space:]')
            if [[ ${#hash} -eq 128 ]]; then
              actual_hash=$(sha512sum "$tar_file" | cut -d' ' -f1)
              if [[ "$actual_hash" == "$hash" ]]; then
                echo "SHA512 verification passed (hash only)"
              else
                echo "SHA512 verification failed!"
                echo "Expected: $hash"
                echo "Actual: $actual_hash"
                exit 1
              fi
            else
              echo "Unknown SHA512 file format"
              cat "$sha512_file"
              exit 1
            fi
          fi
      
          echo "$versions" > $last_freedict_file
          echo "FREEDICT_VERSION=$versions" >> $GITHUB_ENV
          echo "freedict_version=$versions" >> $GITHUB_OUTPUT

      - name: Extract FreeDict archive
        if: steps.check_freedict_version.outputs.freedict_version != ''
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          7z x "freedict-eng-zho-${version}.src.tar.xz" -o.
          7z x "freedict-eng-zho-${version}.src.tar" -o.

      - name: Move dictd files
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          mv eng-zho freedict-eng-zho-${version}
          ls

      - name: Install pyglossary
        run: |
          pip install pyglossary lxml beautifulsoup4 python-idzip tqdm

      - name: Run pyglossary
        env:
          version: ${{ steps.extract_version.outputs.version }}
        run: |
          # tabfile
          pyglossary ./eng-zho/eng-zho.tei ./_freedict-eng-zho-${version}.txt --read-format=FreeDict --write-format=Tabfile --name=
          # tabfile-formatted
          python text_fotmat.py _freedict-eng-zho-${version}.txt _freedict-eng-zho-${version}-formatted.txt
          # stardict
          pyglossary ./_freedict-eng-zho-${version}-formatted.txt ./freedict-eng-zho-${version}-stardict --read-format=Tabfile --write-format=Stardict --name=ECDICT
          # tabfile-formatted-html2ansi
          python html2ansi.py _freedict-eng-zho-${version}-formatted.txt freedict-eng-zho-${version}-formatted-html2ansi.txt
          # sdcv
          pyglossary ./freedict-eng-zho-${version}-formatted-html2ansi.txt ./freedict-eng-zho-${version}-sdcv --read-format=Tabfile --write-format=Stardict --name=ECDICT
          # dictd
          pyglossary ./freedict-eng-zho-${version}-formatted-html2ansi.txt ./freedict-eng-zho-${version}-dictd --read-format=Tabfile --write-format=DictOrg --write-options="dictzip=true" --name=ECDICT
          # yomichan
          pyglossary ./_freedict-eng-zho-${version}-formatted.txt ./freedict-eng-zho-${version}-yomichan.zip --read-format=Tabfile --write-format=Yomichan --name=ECDICT

      - name: Create zip files
        run: |
          for base in *.ifo; do
            prefix="${base%.ifo}"
            if [[ ! -f "$prefix.ifo" ]]; then
              echo "Skipping $prefix, missing $prefix.ifo"
              continue
            fi
            if [[ ! -f "$prefix.idx" ]]; then
              echo "Skipping $prefix, missing $prefix.idx"
              continue
            fi
            # Check which dict file exists: .dict.dz or .dict
            dict_file=""
            if [[ -f "$prefix.dict.dz" ]]; then
              dict_file="$prefix.dict.dz"
            elif [[ -f "$prefix.dict" ]]; then
              dict_file="$prefix.dict"
            else
              echo "Skipping $prefix, missing $prefix.dict.dz or $prefix.dict"
              continue
            fi
            echo "Creating ${prefix}.zip from $prefix.ifo, $dict_file, $prefix.idx"
            zip -j "${prefix}.zip" "$prefix.ifo" "$dict_file" "$prefix.idx"
          done

      - name: Create zip files for Dictd sets
        env:
          version: ${{ steps.extract_version.outputs.version }}
        run: |
          zip -j "freedict-eng-zho-${version}-dictd.zip" "freedict-eng-zho-${version}-dictd.dict.dz" "freedict-eng-zho-${version}-dictd.index"

      - name: Generate SHA256 checksums
        run: |
          for file in ./*.{txt,zip};
          do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256";
              echo "Generated checksum for $file";
            fi
          done

      - name: Extract short name from github.ref
        id: tag_short
        run: echo "short=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          tag_name: ${{ github.ref }}
          name: ${{ steps.tag_short.outputs.short }}
          files: |
            *.sha256
            _*.txt
            freedict-eng-zho-*.zip
