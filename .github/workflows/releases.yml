name: Create Releases

on:
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check latest FreeDict eng-zho source version
        id: check_freedict_version
        run: |
          base_url="https://download.freedict.org/dictionaries/eng-zho/"
          
          echo "Fetching directory listing..."
          html=$(curl -s -L -A "GitHub-Actions-CI" "$base_url")
          
          # Extract latest YYYY.MM.DD version using the regex pattern
          version=$(echo "$html" | grep -oP 'href="(\d{4}\.\d{2}\.\d{2}/)"' | grep -oP '\d{4}\.\d{2}\.\d{2}' | sort -V | tail -1)
          
          if [[ -z "$version" ]]; then
            echo "No FreeDict version found."
            exit 1
          fi
          
          echo "Latest FreeDict version found: $version"
          
          # Convert YYYY.MM.DD to yyyymmdd format for tag/release name
          tag_name=$(echo "$version" | sed 's/\./-/g' | sed 's/-//g')  # e.g., 2024.12.31 -> 20241231
          
          # Check last_version.txt
          last_freedict_file="last_freedict_version.txt"
          if [[ -f $last_freedict_file ]]; then
            last_version=$(cat $last_freedict_file)
            if [[ "$version" == "$last_version" ]]; then
              echo "No new FreeDict version, skipping."
              echo "freedict_version=" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
      
          # Download source (same logic as before)
          tar_url="${base_url}${version}/freedict-eng-zho-${version}.src.tar.xz"
          if ! curl -LO "$tar_url" 2>/dev/null; then
            tar_url="${base_url}freedict-eng-zho-${version}.src.tar.xz"
            curl -LO "$tar_url" || exit 1
          fi
          
          echo "$version" > $last_freedict_file
          echo "FREEDICT_VERSION=$version" >> $GITHUB_ENV
          echo "TAG_NAME=$tag_name" >> $GITHUB_OUTPUT
          echo "RELEASE_NAME=FreeDict eng-zho $version" >> $GITHUB_OUTPUT
          echo "freedict_version=$version" >> $GITHUB_OUTPUT

      - name: Create tag and release
        id: create_release
        if: steps.check_freedict_version.outputs.freedict_version != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.check_freedict_version.outputs.freedict_version }}"
          tag_name="${{ steps.check_freedict_version.outputs.TAG_NAME }}"
          release_name="${{ steps.check_freedict_version.outputs.RELEASE_NAME }}"
          
          # Check if tag already exists
          if git ls-remote --tags origin "refs/tags/$tag_name" | grep -q "$tag_name"; then
            echo "Tag $tag_name already exists, skipping release creation."
            echo "tag_exists=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create lightweight tag
          git tag "$tag_name"
          git push origin "$tag_name"
          
          # Create release - tag_name for BOTH tag and name, title goes in body
          gh release create "$tag_name" \
            --title "$release_name" \
            --notes "FreeDict eng-zho $version - Auto-generated release" \
            --target "${{ github.sha }}"
          
          echo "tag_exists=false" >> $GITHUB_OUTPUT

      - name: Extract FreeDict archive
        if: steps.check_freedict_version.outputs.freedict_version != ''
        run: |
          version="${FREEDICT_VERSION}"
          7z x "freedict-eng-zho-${version}.src.tar.xz" -o.
          7z x "freedict-eng-zho-${version}.src.tar" -o.

      - name: Move dictd files
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          version="${FREEDICT_VERSION}"
          [[ -d eng-zho ]] && mv eng-zho "freedict-eng-zho-${version}"

      - name: Install pyglossary
        run: pip install pyglossary lxml beautifulsoup4 python-idzip tqdm

      - name: Run pyglossary
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          # Same pyglossary commands as before...

      - name: Create zip files
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          version="${FREEDICT_VERSION}"
          # Same zip creation logic...

      - name: Generate SHA256 checksums for ALL .zip and .txt files
        if: steps.check_freedict_version.outputs.freedict_version != ''
        run: |
          for file in ./*.txt ./*.zip; do
            if [[ -f "$file" ]]; then
              sha256sum "$file" > "$file.sha256"
              echo "Generated SHA256 for $file"
            fi
          done
          ls -la *.sha256

      - name: Upload assets to release
        if: steps.check_freedict_version.outputs.freedict_version != '' && steps.create_release.outputs.tag_exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          version="${{ steps.check_freedict_version.outputs.freedict_version }}"
          tag_name="${{ steps.check_freedict_version.outputs.TAG_NAME }}"
          
          # Upload all .zip, .txt, and their corresponding .sha256 files
          for file in ./*.zip ./*.txt; do
            if [[ -f "$file" ]]; then
              sha256_file="${file}.sha256"
              gh release upload "$tag_name" "$file" "$sha256_file" || echo "Failed to upload $file"
            fi
          done
