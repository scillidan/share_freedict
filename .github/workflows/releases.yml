name: Create Releases

on:
  push:
    tags:
      - "*"
  schedule:
    - cron: '0 1 * * 1'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: extract_version
        run: echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl zip

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Check latest FreeDict eng-zho source version
        id: check_freedict_version
        run: |
          base_url="https://download.freedict.org/dictionaries/eng-zho/"
          # Get directory listing and extract version pattern YYYY.MM.DD
          versions=$(curl -s "$base_url" | grep -oP 'freedict-eng-zho-\K\d{4}\.\d{2}\.\d{2}' | sort -V | uniq | tail -1)
          if [[ -z "$versions" ]]; then
            echo "No FreeDict version found."
            exit 1
          fi
          echo "Latest FreeDict version: $versions"

          # Check last_version.txt for this dict
          last_freedict_file="last_freedict_version.txt"
          if [[ -f $last_freedict_file ]]; then
            last_version=$(cat $last_freedict_file)
            if [[ "$versions" == "$last_version" ]]; then
              echo "No new FreeDict version, skipping."
              echo "freedict_version=$versions" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi

          # Download files
          curl -LO "${base_url}freedict-eng-zho-${versions}.src.tar.xz"
          curl -LO "${base_url}freedict-eng-zho-${versions}.src.tar.xz.sha512"

          # Verify SHA512
          echo "$(cat freedict-eng-zho-${versions}.src.tar.xz.sha512)  freedict-eng-zho-${versions}.src.tar.xz" | sha512sum --check
          if [[ $? -ne 0 ]]; then
            echo "SHA512 verification failed!"
            exit 1
          fi

          echo "$versions" > $last_freedict_file
          echo "FREEDICT_VERSION=$versions" >> $GITHUB_ENV
          echo "freedict_version=$versions" >> $GITHUB_OUTPUT

      - name: Extract FreeDict archive
        if: steps.check_freedict_version.outputs.freedict_version != ''
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          7z x "freedict-eng-zho-${version}.src.tar.xz" -o.
          7z x "freedict-eng-zho-${version}.src.tar" -o.

      - name: Move dictd files
        env:
          version: ${{ steps.check_freedict_version.outputs.freedict_version }}
        run: |
          mv eng-zho freedict-eng-zho-${version}
          ls

      - name: Install pyglossary
        run: |
          pip install pyglossary lxml beautifulsoup4 python-idzip tqdm

      - name: Run pyglossary
        env:
          version: ${{ steps.extract_version.outputs.version }}
        run: |
          # tabfile
          pyglossary ./eng-zho/eng-zho.tei ./_freedict-eng-zho-${version}.txt --read-format=FreeDict --write-format=Tabfile --name=
          # tabfile-formatted
          python text_fotmat.py _freedict-eng-zho-${version}.txt _freedict-eng-zho-${version}-formatted.txt
          # stardict
          pyglossary ./_freedict-eng-zho-${version}-formatted.txt ./freedict-eng-zho-${version}-stardict --read-format=Tabfile --write-format=Stardict --name=ECDICT
          # tabfile-formatted-html2ansi
          python html2ansi.py _freedict-eng-zho-${version}-formatted.txt freedict-eng-zho-${version}-formatted-html2ansi.txt
          # sdcv
          pyglossary ./freedict-eng-zho-${version}-formatted-html2ansi.txt ./freedict-eng-zho-${version}-sdcv --read-format=Tabfile --write-format=Stardict --name=ECDICT
          # dictd
          pyglossary ./freedict-eng-zho-${version}-formatted-html2ansi.txt ./freedict-eng-zho-${version}-dictd --read-format=Tabfile --write-format=DictOrg --write-options="dictzip=true" --name=ECDICT
          # yomichan
          pyglossary ./_freedict-eng-zho-${version}-formatted.txt ./freedict-eng-zho-${version}-yomichan.zip --read-format=Tabfile --write-format=Yomichan --name=ECDICT

      - name: Create zip files
        run: |
          for base in *.ifo; do
            prefix="${base%.ifo}"
            if [[ ! -f "$prefix.ifo" ]]; then
              echo "Skipping $prefix, missing $prefix.ifo"
              continue
            fi
            if [[ ! -f "$prefix.idx" ]]; then
              echo "Skipping $prefix, missing $prefix.idx"
              continue
            fi
            # Check which dict file exists: .dict.dz or .dict
            dict_file=""
            if [[ -f "$prefix.dict.dz" ]]; then
              dict_file="$prefix.dict.dz"
            elif [[ -f "$prefix.dict" ]]; then
              dict_file="$prefix.dict"
            else
              echo "Skipping $prefix, missing $prefix.dict.dz or $prefix.dict"
              continue
            fi
            echo "Creating ${prefix}.zip from $prefix.ifo, $dict_file, $prefix.idx"
            zip -j "${prefix}.zip" "$prefix.ifo" "$dict_file" "$prefix.idx"
          done

      - name: Create zip files for Dictd sets
        env:
          version: ${{ steps.extract_version.outputs.version }}
        run: |
          zip -j "freedict-eng-zho-${version}-dictd.zip" "freedict-eng-zho-${version}-dictd.dict.dz" "freedict-eng-zho-${version}-dictd.index"

      - name: Generate SHA256 checksums
        run: |
          for file in ./*.{txt,zip};
          do
            if [ -f "$file" ]; then
              sha256sum "$file" > "$file.sha256";
              echo "Generated checksum for $file";
            fi
          done

      - name: Extract short name from github.ref
        id: tag_short
        run: echo "short=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Release
        uses: softprops/action-gh-release@v2
        if: github.ref_type == 'tag'
        with:
          tag_name: ${{ github.ref }}
          name: ${{ steps.tag_short.outputs.short }}
          files: |
            *.sha256
            _*.txt
            freedict-eng-zho-*.zip
